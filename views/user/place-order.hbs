<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/MaterialDesign-Webfont/5.3.45/css/materialdesignicons.css"
    integrity="sha256-NAxhqDvtY0l4xn+YVa6WjAcmd94NNfttjNsDmNatFVc=" crossorigin="anonymous" />
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<link rel="stylesheet" href="/stylesheets/style.css">


<form action="/place-order" method="POST" id="placeOrderForm">
    <div class="container">

        <div class="row">
            <div class="col-xl-8">
                <div class="card">
                    <div class="card-body">
                        <ol class="activity-checkout mb-0 px-4 mt-3">

                            <!-- Billing Info -->
                            <li class="checkout-item">
                                <div class="avatar checkout-icon p-1">
                                    <div class="avatar-title rounded-circle bg-primary">
                                        <i class="bx bxs-receipt text-white font-size-20"></i>
                                    </div>
                                </div>
                                <div class="feed-item-list">
                                    <div>
                                        <h5 class="font-size-16 mb-1">Billing Info</h5>
                                        <div class="mb-3">
                                            <div class="row">
                                                <div class="col-lg-4">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="billingName">Name</label>
                                                        <input type="text" class="form-control" name="billingName"
                                                            id="billingName" placeholder="Enter Name" required>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="billingEmailAddress">Email
                                                            Address</label>
                                                        <input type="email" class="form-control" name="billingEmail"
                                                            id="billingEmailAddress" placeholder="Enter Email" required>
                                                    </div>
                                                </div>
                                                <div class="col-lg-4">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="billingPhone">Phone</label>
                                                        <input type="text" class="form-control" name="billingPhone"
                                                            id="billingPhone" placeholder="Enter Phone no." required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label" for="billingAddress">Address</label>
                                                <textarea class="form-control" name="billingAddress" id="billingAddress"
                                                    rows="3" placeholder="Enter full address" required></textarea>
                                            </div>

                                            <div class="col-lg-4">
                                                <div class="mb-0">
                                                    <label class="form-label" for="zipCode">Zip / Postal code</label>
                                                    <input type="text" class="form-control" name="zipCode" id="zipCode"
                                                        placeholder="Enter Postal code" required>
                                                </div>
                                            </div>
                                            <input type="hidden" name="userId" value="{{user._id}}">
                                        </div>
                                    </div>
                                </div>
                            </li>

                            <!-- Payment Info -->
                            <li class="checkout-item">
                                <div class="avatar checkout-icon p-1">
                                    <div class="avatar-title rounded-circle bg-primary">
                                        <i class="bx bxs-wallet-alt text-white font-size-20"></i>
                                    </div>
                                </div>
                                <div class="feed-item-list">
                                    <div>
                                        <h5 class="font-size-16 mb-1">Payment Info</h5>
                                        <h5 class="font-size-14 mb-3">Payment method :</h5>
                                        <div class="row">
                                            <div class="col-lg-3 col-sm-6">
                                                <label class="card-radio-label">
                                                    <input type="radio" name="paymentMethod" id="pay-methodoption3"
                                                        value="Cash on Delivery" class="card-radio-input" checked>
                                                    <span class="card-radio py-3 text-center text-truncate">
                                                        <i class="bx bx-money d-block h2 mb-3"></i>
                                                        <span>Cash on Delivery</span>
                                                    </span>
                                                </label>
                                            </div>
                                            <div class="col-lg-3 col-sm-6">
                                                <div data-bs-toggle="collapse">
                                                    <label class="card-radio-label">
                                                        <input type="radio" name="paymentMethod" id="pay-methodoption1"
                                                            value="Online Payment" class="card-radio-input">
                                                        <span class="card-radio py-3 text-center text-truncate">
                                                            <i class="bx bx-credit-card d-block h2 mb-3"></i>
                                                            Online Payment
                                                        </span>
                                                    </label>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </li>

                        </ol>
                    </div>
                </div>

                <!-- Back to shopping -->
                <div class="row my-4">
                    <div class="col">
                        <a href="/" class="btn btn-link text-muted">
                            <i class="mdi mdi-arrow-left me-1"></i> Continue Shopping
                        </a>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="col-xl-4">
                <div class="card checkout-order-summary">
                    <div class="card-body">
                        <div class="p-3 bg-light mb-3">
                            <h5 class="font-size-16 mb-0">
                                Order Summary
                                <span class="float-end ms-2">#MN0124</span>
                            </h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-centered mb-0 table-nowrap">
                                <thead>
                                    <tr>
                                        <th class="border-top-0" style="width: 110px;" scope="col">Product</th>
                                        <th class="border-top-0" scope="col">Product Desc</th>
                                        <th class="border-top-0" scope="col">Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each cart}}
                                    <tr>
                                        <th scope="row">
                                            <img src="/product-images/{{product._id}}.jpg" alt="{{product.name}}"
                                                class="avatar-lg rounded">
                                        </th>
                                        <td>
                                            <h5 class="font-size-16 text-truncate">{{product.name}}</h5>
                                            <p class="text-muted mb-0 mt-1">₹ {{product.price}} x {{quantity}}</p>
                                        </td>
                                        <td>₹ {{subtotal}}</td>
                                    </tr>
                                    {{/each}}

                                    <tr class="bg-light">
                                        <td colspan="2">
                                            <h5 class="font-size-14 m-0">Total:</h5>
                                        </td>
                                        <td>₹ {{total}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Place Order Button -->
                <div class="col">
                    <div class="text-end mt-2 mt-sm-0">
                        <button type="submit" class="btn btn-success">
                            <i class="mdi mdi-cart-outline me-1"></i> Proceed
                        </button>
                    </div>
                </div>
            </div>

        </div> <!-- end row -->
    </div> <!-- end container -->
</form>



<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    $(document).ready(function() {
        $("#placeOrderForm").submit(function(e) {
            e.preventDefault();
            $.ajax({
                url: '/place-order',
                method: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    if (response.codSuccess) {
                        alert('Order Placed Successfully');
                        location.href = '/orders';
                    } else if (response.id) {
                        // Only open Razorpay modal for online payment
                        razorpayPayment(response);
                    } else {
                        alert('Order failed!');
                    }
                }
            });
        });

        function razorpayPayment(order) {
            var options = {
                "key": "{{razorpayKey}}",
                "amount": order.amount,
                "currency": "INR",
                "name": "LumoVale",
                "description": "Order Payment",
                "order_id": order.id,
                "handler": function (paymentResponse) {
                    verifyPayment(paymentResponse, order);
                },
                "theme": {
                    "color": "#3399cc"
                }
            };
            var rzp1 = new Razorpay(options);
            rzp1.open();
        }

        function verifyPayment(payment, order) {
            $.ajax({
                url: '/verifyPayment',
                data: JSON.stringify({ payment, order }),
                contentType: 'application/json',
                method: 'POST',
                success: function(response) {
                    if (response.status) {
                        alert('Payment Successful!');
                        location.href = '/orders';
                    } else {
                        alert('Payment Failed: ' + (response.error || 'Unknown error'));
                    }
                }
            });
        }
    });
</script>